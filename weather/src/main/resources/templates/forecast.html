<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤©ç©¹ - å¤©æ°”æŸ¥è¯¢ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/css/colors.css">
    <link rel="stylesheet" href="/css/style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="/js/anime.js" defer></script>
    <!-- å¼•å…¥marked.jsç”¨äºMarkdownæ¸²æŸ“ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- å¼•å…¥Chart.jsç”¨äºç»˜åˆ¶å›¾è¡¨ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- å¼•å…¥Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
<script th:utext="'window.weatherdata = ' + ${weatherdataJson} + ';'" ></script>
<div class="forecast-container">
    <!-- æŸ¥è¯¢ç•Œé¢ -->
    <div id="queryView" th:if="${weatherdata == null}">
        <div class="forecast-header" id="queryHeader">
            <div class="option city-option" id="cityOption" th:classappend="${selectedCityName} != '' ? ' selected' : ''">
                <span th:text="${selectedCityName} != '' ? ${selectedCityName} : 'åŸå¸‚'" id="cityOptionText"></span>
            </div>
            <div class="option days-option" id="daysOption" th:classappend="${selectedType == '7' or selectedType == '1'} ? ' selected' : ''">
                <span th:text="${selectedType == '7'} ? '7å¤©' : (${selectedType == '1'} ? '1å¤©' : 'å¤©æ•°')" id="daysOptionText"></span>
            </div>
            <div class="option province-option" id="provinceBubbleFloat" style="display:none;" tabindex="0">çœä»½</div>
            <div class="province-dropdown" id="provinceDropdown" style="display:none;">
                <input type="text" id="provinceSearch" placeholder="æœç´¢çœä»½" autocomplete="off">
                <div id="provinceDropdownList"></div>
            </div>
            <select id="cityId" name="cityId" style="display:none;">
                <option value="">è¯·é€‰æ‹©æŸ¥è¯¢åŸå¸‚</option>
                <th:block th:each="city : ${cityList}">
                    <option th:value="${city.cityId}" th:text="${city.city}" th:selected="${city.cityId} == ${selectedCityId}"></option>
                </th:block>
            </select>
            <select id="type" name="type" style="display:none;">
                <option value="1" th:selected="${selectedType == '1'}">1å¤©</option>
                <option value="7" th:selected="${selectedType == '7'}">7å¤©</option>
            </select>
        </div>
        <svg id="connectLine" class="connect-line" width="100vw" height="100vh" style="position:absolute;top:0;left:0;z-index:1;pointer-events:none;"></svg>
        <svg id="cityToProvinceLine" class="connect-line" width="100vw" height="100vh" style="position:absolute;top:0;left:0;z-index:2;pointer-events:none;"></svg>
        <div id="cityBubbleFloatContainer"></div>
        <div class="forecast-title-on-semicircle" id="forecastTitleOnSemicircle">å¤©ç©¹</div>
        <div class="forecast-semicircle clickable" id="forecastSemicircle">
            <div class="weather-gif">
                <video id="randomWeatherVideo" autoplay loop muted playsinline
                    style="width: 100%; height: 100%; object-fit: contain; transform: scale(1.5) translateY(150px); transform-origin: center center;">
                    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒ video æ ‡ç­¾
                </video>
            </div>
        </div>
    </div>
    <!-- ç»“æœç•Œé¢ -->
    <div id="resultView" th:if="${weatherdata != null}">
        <!-- å¤åˆ¶ä¸€ä»½åŠåœ†å’Œæ ‡é¢˜åˆ°ç»“æœç•Œé¢ -->
        <div class="forecast-title-on-semicircle result-title">å¤©ç©¹</div>
        <!-- ç»Ÿä¸€åŠåœ†å½¢éƒ¨ä»¶ -->
        <div class="forecast-semicircle result-semicircle">
            <div class="weather-gif">
                <video id="weatherVideo" autoplay loop muted playsinline
                    style="width: 100%; height: 100%; object-fit: contain; transform: scale(1.5) translateY(150px); transform-origin: center center;">
                    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒ video æ ‡ç­¾
                </video>
            </div>
        </div>
        <div id="result1View" th:if="${weatherdata.result != null and selectedType == '1'}">
            <div class="info-tab-bar">
                <div class="info-tab active" data-group="main">åŸºæœ¬ä¿¡æ¯</div>
                <div class="info-tab" data-group="temp">æ¸©åº¦ä¿¡æ¯</div>
                <div class="info-tab" data-group="wind">é£ä¿¡æ¯</div>
                <div class="info-tab" data-group="humidity">å…¶ä»–ä¿¡æ¯</div>
                <div class="info-tab" data-group="astro">å¤©æ–‡ä¿¡æ¯</div>
            </div>
            <div class="forecast-detail detail-1day">
                <!-- 5ä¸ªåˆ†ç»„å†…å®¹divï¼Œä»…æ˜¾ç¤ºactiveåˆ†ç»„ -->
                <div class="info-tab-content active" data-group="main">
                    <div><span class="detail-label">æ—¥æœŸï¼š</span><span th:text="${weatherdata.result.date + ' ' + weatherdata.result.week}"></span></div>
                    <div><span class="detail-label">å¤©æ°”ï¼š</span><span th:text="${weatherdata.result.weather}"></span><img th:if="${weatherIconPath != null}" th:src="${weatherIconPath}" alt="å¤©æ°”å›¾æ ‡" style="height: 32px; vertical-align: middle; margin-left: 10px;"/></div>
                    <div><span class="detail-label">ç”Ÿæ´»å»ºè®®: </span><span th:text="${weatherdata.result.tips}"></span></div>
                    <div class="detail-poem" th:if="${weatherdata.result.poem != null and !#strings.isEmpty(weatherdata.result.poem)}">&ldquo;<span th:text="${weatherdata.result.poem}"></span>&rdquo;</div>
                </div>
                <div class="info-tab-content" data-group="temp">
                    <div class="row">
                        <div class="col-md-6">
                            <div><span class="detail-label">å®æ—¶æ¸©åº¦:</span><span th:text="${weatherdata.result.real}"></span></div>
                            <div><span class="detail-label">æœ€ä½:</span><span th:text="${weatherdata.result.lowest}"></span></div>
                            <div><span class="detail-label">æœ€é«˜:</span><span th:text="${weatherdata.result.highest}"></span></div>
                        </div>
                        <div class="col-md-6">
                            <div class="temperature-chart">
                                <canvas id="temperatureChart" width="200" height="150"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="info-tab-content" data-group="wind">
                    <div><span class="detail-label">é£å‘:</span><span th:text="${weatherdata.result.wind}"></span></div>
                    <div><span class="detail-label">é£é€Ÿ:</span><span th:text="${weatherdata.result.windspeed}"></span></div>
                    <div><span class="detail-label">é£åŠ›:</span><span th:text="${weatherdata.result.windsc}"></span></div>
                </div>
                <div class="info-tab-content" data-group="humidity">
                    <div><span class="detail-label">æ¹¿åº¦:</span><span th:text="${weatherdata.result.humidity}"></span></div>
                    <div><span class="detail-label">é™æ°´é‡:</span><span th:text="${weatherdata.result.pcpn}"></span></div>
                    <div><span class="detail-label">ç´«å¤–çº¿æŒ‡æ•°:</span><span th:text="${weatherdata.result.uv_index}"></span></div>
                    <div><span class="detail-label">èƒ½è§åº¦:</span><span th:text="${weatherdata.result.vis}"></span></div>
                </div>
                <div class="info-tab-content" data-group="astro">
                    <div><span class="detail-label">æ—¥å‡ºæ—¶é—´:</span><span th:text="${weatherdata.result.sunrise}"></span></div>
                    <div><span class="detail-label">æ—¥è½æ—¶é—´:</span><span th:text="${weatherdata.result.sunset}"></span></div>
                    <div><span class="detail-label">æœˆå‡æ—¶é—´:</span><span th:text="${weatherdata.result.moonrise}"></span></div>
                    <div><span class="detail-label">æœˆè½æ—¶é—´:</span><span th:text="${weatherdata.result.moondown}"></span></div>
                </div>
            </div>
            <div class="result1-fixed-options">
                <div class="fixed-city">åŸå¸‚ï¼š<span th:text="${selectedCityName}"></span></div>
                <div class="fixed-days">å¤©æ•°ï¼š1å¤©</div>
            </div>
        </div>
        <div id="result7View" th:if="${weatherdata.result != null and selectedType == '7' and weatherdata.result.list != null}">
            <div class="seven-days-layout d-flex flex-column align-items-center" style="min-height: 500px;">
                <!-- é¡¶éƒ¨æ—¥æœŸå’Œå¤©æ°”é€‰é¡¹å¡ -->
                <div class="seven-days-top d-flex justify-content-center align-items-center mb-3" style="gap: 1.2rem;">
                    <div th:each="day,idx : ${weatherdata.result.list}" class="seven-day-tab" th:classappend="${idx.index == 0} ? 'active' : ''" th:data-idx="${idx.index}">
                        <div th:text="${day.date}" style="font-size: 1.05rem;"></div>
                        <div th:text="${day.week}" style="font-size: 0.95rem; color: var(--main-blue2);"></div>
                        <div class="mt-1 d-flex align-items-center justify-content-center">
                            <span th:text="${day.weather}" style="font-size: 0.95rem;"></span>
                            <img th:if="${day.weatherimg != null}" th:src="@{'/images/png/' + ${day.weatherimg}}" alt="å¤©æ°”å›¾æ ‡" style="height: 22px; margin-left: 6px;"/>
                        </div>
                    </div>
                </div>
                <div class="d-flex flex-row w-100 justify-content-center align-items-stretch" style="min-height: 350px;">
                    <!-- å·¦ä¾§æ°”è±¡è¦ç´ å›¾æ ‡åŒº -->
                    <div class="seven-days-icons d-flex flex-column align-items-center justify-content-center me-4" style="gap: 1.2rem;">
                        <button class="icon-btn btn btn-light mb-1 active" data-factor="real"><i class="bi bi-thermometer-half" style="font-size:2rem;"></i><div style="font-size:0.9rem;">å®æ—¶æ¸©åº¦</div></button>
                        <button class="icon-btn btn btn-light mb-1" data-factor="lowest"><i class="bi bi-thermometer-snow" style="font-size:2rem;"></i><div style="font-size:0.9rem;">æœ€ä½æ¸©åº¦</div></button>
                        <button class="icon-btn btn btn-light mb-1" data-factor="highest"><i class="bi bi-thermometer-sun" style="font-size:2rem;"></i><div style="font-size:0.9rem;">æœ€é«˜æ¸©åº¦</div></button>
                        <button class="icon-btn btn btn-light mb-1" data-factor="windspeed"><i class="bi bi-wind" style="font-size:2rem;"></i><div style="font-size:0.9rem;">é£é€Ÿ</div></button>
                        <button class="icon-btn btn btn-light mb-1" data-factor="humidity"><i class="bi bi-droplet" style="font-size:2rem;"></i><div style="font-size:0.9rem;">æ¹¿åº¦</div></button>
                        <button class="icon-btn btn btn-light mb-1" data-factor="pcpn"><i class="bi bi-cloud-rain" style="font-size:2rem;"></i><div style="font-size:0.9rem;">é™æ°´é‡</div></button>
                        <button class="icon-btn btn btn-light mb-1" data-factor="uv_index"><i class="bi bi-sun" style="font-size:2rem;"></i><div style="font-size:0.9rem;">ç´«å¤–çº¿</div></button>
                        <button class="icon-btn btn btn-light mb-1" data-factor="vis"><i class="bi bi-eye" style="font-size:2rem;"></i><div style="font-size:0.9rem;">èƒ½è§åº¦</div></button>
                    </div>
                    <!-- ä¸­é—´è¯¦ç»†æ•°æ®åŒº -->
                    <div class="seven-days-detail flex-grow-1 d-flex flex-column align-items-center justify-content-center" style="min-width: 320px; max-width: 600px;">
                        <!-- æ—¥æœŸä¸‹æ–¹è¯¦ç»†æ•°æ®ï¼Œé»˜è®¤æ˜¾ç¤ºç¬¬ä¸€å¤© -->
                        <div th:each="day,idx : ${weatherdata.result.list}" th:id="'seven-day-detail-' + ${idx.index}"
                             th:style="${idx.index == 0} ? '' : 'display:none;'" class="seven-day-detail-content w-100">
                            <div class="mb-2 text-center" style="font-size:1.2rem;font-weight:bold;">
                                <span th:text="${day.date + ' ' + day.week}"></span>
                            </div>
                            <div class="mb-2 text-center" style="font-size:1.1rem;">
                                <span th:text="${day.weather}"></span>
                                <img th:if="${day.weatherimg != null}" th:src="@{'/images/png/' + ${day.weatherimg}}" alt="å¤©æ°”å›¾æ ‡" style="height: 28px; margin-left: 8px;"/>
                            </div>
                            <div class="row justify-content-center mb-2">
                                <div class="col-4"><strong>å®æ—¶æ¸©åº¦:</strong> <span class="real-temp" th:text="${day.real}"></span></div>
                                <div class="col-4"><strong>æœ€ä½:</strong> <span class="lowest-temp" th:text="${day.lowest}"></span></div>
                                <div class="col-4"><strong>æœ€é«˜:</strong> <span class="highest-temp" th:text="${day.highest}"></span></div>
                            </div>
                            <div class="row justify-content-center mb-2">
                                <div class="col-4"><strong>é£é€Ÿ:</strong> <span class="windspeed" th:text="${day.windspeed}"></span></div>
                                <div class="col-4"><strong>æ¹¿åº¦:</strong> <span class="humidity" th:text="${day.humidity}"></span></div>
                                <div class="col-4"><strong>é™æ°´é‡:</strong> <span class="pcpn" th:text="${day.pcpn}"></span></div>
                            </div>
                            <div class="row justify-content-center mb-2">
                                <div class="col-4"><strong>ç´«å¤–çº¿:</strong> <span class="uv_index" th:text="${day.uv_index}"></span></div>
                                <div class="col-4"><strong>èƒ½è§åº¦:</strong> <span class="vis" th:text="${day.vis}"></span></div>
                            </div>
                            <div class="mt-2 text-center" th:if="${day.tips != null}"><strong>ç”Ÿæ´»å»ºè®®:</strong> <span th:text="${day.tips}"></span></div>
                            <div class="mt-2 text-center" th:if="${day.poem != null and !#strings.isEmpty(day.poem)}">&ldquo;<span th:text="${day.poem}"></span>&rdquo;</div>
                        </div>
                        <!-- æŠ˜çº¿å›¾åŒºåŸŸ -->
                        <div class="seven-days-chart-area w-100 d-flex justify-content-center align-items-center mt-3" style="min-height:220px; display:none;">
                            <canvas id="sevenDaysChart" width="420" height="180"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- åªåœ¨ç»“æœç•Œé¢æ˜¾ç¤ºAIåŠ©æ‰‹æŒ‰é’®å’Œå¼¹çª— -->
        <div id="ai-assistant-btn" style="display:none; position:fixed; right:32px; bottom:32px; z-index:1000; background:var(--main-pink3); color:#fff; border-radius:50%; width:64px; height:64px; box-shadow:0 4px 16px rgba(0,0,0,0.18); display:flex; align-items:center; justify-content:center; font-size:2rem; cursor:pointer;">
        ğŸ¤–
        </div>
        <div id="ai-assistant-modal" style="display:none; position:fixed; right:112px; bottom:112px; z-index:1001; background:#fff; color:var(--text-main); border-radius:18px; box-shadow:0 8px 32px rgba(0,0,0,0.18); padding:2rem; min-width:320px; max-width:420px; max-height:60vh; overflow:auto;">
            <div style="font-weight:bold; font-size:1.2rem; margin-bottom:1rem;">AIå¤©æ°”åˆ†æåŠ©æ‰‹</div>
            <div id="ai-assistant-content" style="white-space:pre-line; font-size:1.05rem;"></div>
            <button id="ai-assistant-close" style="margin-top:1.5rem; float:right; background:var(--main-pink3); color:#fff; border:none; border-radius:8px; padding:0.5em 1.2em; cursor:pointer;">å…³é—­</button>
        </div>
    </div>
    <!-- å›¾è¡¨å¼¹çª—åŒºåŸŸ -->
    <div id="sevenDaysChartModal" class="seven-days-chart-modal" style="display:none;">
        <button class="seven-days-chart-close" onclick="document.getElementById('sevenDaysChartModal').style.display='none'">&times;</button>
        <canvas id="sevenDaysChart" width="420" height="180"></canvas>
    </div>
</div>
<script th:inline="javascript">
    /*<![CDATA[*/
    window.provinceCityMap = [[${provinceCityMap}]];
    window.provinceListData = [[${provinceListData}]];
    /*]]>*/

    // é«˜å¾·IPå®šä½è‡ªåŠ¨å¡«å……åŸå¸‚
    document.addEventListener('DOMContentLoaded', function() {
        // åªåœ¨æŸ¥è¯¢ç•Œé¢æ‰§è¡Œ
        if (document.getElementById('queryView')) {
            fetch('https://restapi.amap.com/v3/ip?key=efb0dec50dc30afccaa0903e671a058b&output=json')
                .then(res => res.json())
                .then(data => {
                    console.log('é«˜å¾·IPå®šä½è¿”å›:', data);
                    if (data.status === '1' && data.city) {
                        const city = data.city;
                        // å¼¹çª—è¯¢é—®
                        if (confirm(`ä½ æ‰€åœ¨çš„åœ°åŒºæ˜¯ ${city}ï¼Œæ˜¯å¦é»˜è®¤ä½¿ç”¨è¯¥åœ°åŒºè¿›è¡Œå¤©æ°”æŸ¥è¯¢ï¼Ÿ`)) {
                            // è‡ªåŠ¨å¡«å…¥åŸå¸‚ä¸‹æ‹‰æ¡†
                            const citySelect = document.getElementById('cityId');
                            if (citySelect) {
                                for (let i = 0; i < citySelect.options.length; i++) {
                                    if (citySelect.options[i].text === city) {
                                        citySelect.selectedIndex = i;
                                        // è§¦å‘ä¸‹æ‹‰æ¡†å˜æ›´äº‹ä»¶ï¼ˆå¦‚æœ‰è”åŠ¨ï¼‰
                                        citySelect.dispatchEvent(new Event('change'));
                                        // åŒæ­¥æ˜¾ç¤ºåˆ°æŒ‰é’®
                                        const cityOptionText = document.getElementById('cityOptionText');
                                        if (cityOptionText) cityOptionText.innerText = city;
                                        break;
                                    }
                                }
                            }
                        }
                    } else {
                        alert('é«˜å¾·IPå®šä½å¤±è´¥: ' + (data.info || JSON.stringify(data)));
                    }
                })
                .catch(e => {
                    alert('é«˜å¾·IPå®šä½è¯·æ±‚å¼‚å¸¸: ' + e);
                });
        }
    });

    // ç¦æ­¢æœªé€‰å¤©æ•°æ—¶æŸ¥è¯¢
    document.addEventListener('DOMContentLoaded', function() {
        var queryBtn = document.getElementById('forecastSemicircle');
        if (queryBtn) {
            queryBtn.addEventListener('click', function(e) {
                var type = document.getElementById('type').value;
                if (!type) {
                    alert('è¯·é€‰æ‹©å¤©æ•°');
                    e.stopPropagation();
                    e.preventDefault();
                    return false;
                }
            }, true);
        }
    });

    // åªåœ¨ç»“æœç•Œé¢æ˜¾ç¤ºAIåŠ©æ‰‹æŒ‰é’®
    if (document.getElementById('resultView')) {
        document.getElementById('ai-assistant-btn').style.display = 'flex';
        let aiModal = document.getElementById('ai-assistant-modal');
        let aiBtn = document.getElementById('ai-assistant-btn');
        let aiContent = document.getElementById('ai-assistant-content');
        let aiClose = document.getElementById('ai-assistant-close');
        let aiResultCache = null; // ç¼“å­˜AIåˆ†æç»“æœ
        aiBtn.onclick = function() { 
            aiModal.style.display = 'block';
            if (aiResultCache) {
                aiContent.innerHTML = aiResultCache;
            }
        };
        aiClose.onclick = function() { aiModal.style.display = 'none'; };
        // è‡ªåŠ¨è·å–å¤©æ°”æ•°æ®å¹¶è¯·æ±‚AIåˆ†æ
        let weatherData = '';
        try {
            // ä¼˜å…ˆç”¨window.weatherdata.resultç»“æ„
            if (window.weatherdata && window.weatherdata.result) {
                let w = window.weatherdata.result;
                weatherData =
                    'åŸå¸‚: ' + (w.province || '') + ' ' + (w.area || '') + '\n' +
                    'æ—¥æœŸ: ' + (w.date || '') + ' ' + (w.week || '') + '\n' +
                    'å¤©æ°”: ' + (w.weather || '') + '\n' +
                    'å®æ—¶æ¸©åº¦: ' + (w.real || '') + '\n' +
                    'æœ€ä½: ' + (w.lowest || '') + '\n' +
                    'æœ€é«˜: ' + (w.highest || '') + '\n' +
                    'é£å‘: ' + (w.wind || '') + '\n' +
                    'é£é€Ÿ: ' + (w.windspeed || '') + '\n' +
                    'é£åŠ›: ' + (w.windsc || '') + '\n' +
                    'æ¹¿åº¦: ' + (w.humidity || '') + '\n' +
                    'é™æ°´é‡: ' + (w.pcpn || '') + '\n' +
                    'ç´«å¤–çº¿æŒ‡æ•°: ' + (w.uv_index || '') + '\n' +
                    'èƒ½è§åº¦: ' + (w.vis || '') + '\n' +
                    'æ—¥å‡º: ' + (w.sunrise || '') + '\n' +
                    'æ—¥è½: ' + (w.sunset || '') + '\n' +
                    'æœˆå‡: ' + (w.moonrise || '') + '\n' +
                    'æœˆè½: ' + (w.moondown || '');
            } else {
                // å…œåº•ï¼šä»é¡µé¢æŠ“å–ä¸»è¦å­—æ®µ
                let main = document.querySelector('.info-tab-content[data-group="main"]');
                if (main) weatherData += main.innerText + '\n';
                let temp = document.querySelector('.info-tab-content[data-group="temp"]');
                if (temp) weatherData += temp.innerText + '\n';
                let wind = document.querySelector('.info-tab-content[data-group="wind"]');
                if (wind) weatherData += wind.innerText + '\n';
                let hum = document.querySelector('.info-tab-content[data-group="humidity"]');
                if (hum) weatherData += hum.innerText + '\n';
                let astro = document.querySelector('.info-tab-content[data-group="astro"]');
                if (astro) weatherData += astro.innerText + '\n';
            }
        } catch(e) {}
        if (weatherData) {
            aiContent.innerText = 'AIåˆ†æä¸­...';
            fetch('/api/ai-analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ weatherInfo: weatherData })
            })
            .then(res => res.json())
            .then(data => {
                if (data.result) {
                    aiResultCache = window.marked ? marked.parse(data.result) : data.result;
                    aiContent.innerHTML = aiResultCache;
                } else if (data.error) {
                    aiResultCache = 'AIåˆ†æå¤±è´¥ï¼š' + (data.detail || data.error);
                    aiContent.innerText = aiResultCache;
                } else {
                    aiResultCache = 'AIæœªèƒ½è¿”å›åˆ†æç»“æœã€‚';
                    aiContent.innerText = aiResultCache;
                }
            })
            .catch(e => {
                aiResultCache = 'AIåˆ†æå¤±è´¥ï¼š' + e;
                aiContent.innerText = aiResultCache;
            });
        } else {
            aiResultCache = 'æœªèƒ½è·å–å¤©æ°”æ•°æ®ï¼Œæ— æ³•åˆ†æã€‚';
            aiContent.innerText = aiResultCache;
        }
    }
</script>
<script>
// 1å¤©ç•Œé¢tabåˆ‡æ¢åŠŸèƒ½
(function() {
  if (document.getElementById('result1View')) {
    const tabs = document.querySelectorAll('#result1View .info-tab');
    const contents = document.querySelectorAll('#result1View .info-tab-content');
    tabs.forEach(tab => {
      tab.addEventListener('click', function() {
        // ç§»é™¤æ‰€æœ‰tabçš„active
        tabs.forEach(t => t.classList.remove('active'));
        // éšè—æ‰€æœ‰å†…å®¹
        contents.forEach(c => c.classList.remove('active'));
        // å½“å‰tabé«˜äº®
        this.classList.add('active');
        // æ˜¾ç¤ºå¯¹åº”å†…å®¹
        const group = this.getAttribute('data-group');
        document.querySelector(`#result1View .info-tab-content[data-group="${group}"]`).classList.add('active');
      });
    });
  }
})();
</script>
<script>
// éšæœºè§†é¢‘æ–‡ä»¶ååˆ—è¡¨
const weatherVideos = [
  'mai.mp4','wu.mp4','dawu.mp4','shachenbao.mp4','yangsha.mp4','fuchen.mp4','bingbao.mp4','yujiaxue.mp4','xue.mp4','xiaoxue.mp4','zhongxue.mp4','baoxue.mp4','daxue.mp4','dongyu.mp4','tedabaoyu.mp4','dabaoyu.mp4','yu.mp4','zhenyu.mp4','xiaoyu.mp4','zhongyu.mov','baoyu.mp4','dayu.mp4','leizhenyu.mp4','duoyun.mp4','qing.mp4','yin.mp4'
];
function getRandomVideo() {
  const idx = Math.floor(Math.random() * weatherVideos.length);
  return '/videos/' + weatherVideos[idx];
}
// æŸ¥è¯¢ç•Œé¢
const randomVideoEl = document.getElementById('randomWeatherVideo');
if(randomVideoEl) {
  randomVideoEl.src = getRandomVideo();
}
</script>
<script>
// æ¸©åº¦å›¾è¡¨ç»˜åˆ¶åŠŸèƒ½
function drawTemperatureChart() {
    const canvas = document.getElementById('temperatureChart');
    if (!canvas) {
        console.log('Canvas not found');
        return;
    }
    
    // è·å–æ¸©åº¦æ•°æ® - ä½¿ç”¨åŸç”ŸJavaScriptæ–¹æ³•
    const tempContent = document.querySelector('.info-tab-content[data-group="temp"]');
    if (!tempContent) {
        console.log('Temperature content not found');
        return;
    }
    
    // ä½¿ç”¨åŸç”ŸJavaScriptè·å–æ¸©åº¦æ•°æ®
    const tempDivs = tempContent.querySelectorAll('div');
    let realTemp, lowestTemp, highestTemp;
    
    tempDivs.forEach(div => {
        const label = div.querySelector('.detail-label');
        if (label) {
            const value = div.querySelector('span:not(.detail-label)');
            if (value) {
                if (label.textContent.includes('å®æ—¶æ¸©åº¦')) {
                    realTemp = parseInt(value.textContent);
                } else if (label.textContent.includes('æœ€ä½')) {
                    lowestTemp = parseInt(value.textContent);
                } else if (label.textContent.includes('æœ€é«˜')) {
                    highestTemp = parseInt(value.textContent);
                }
            }
        }
    });
    
    console.log('Temperature data:', { realTemp, lowestTemp, highestTemp });
    
    if (isNaN(realTemp) || isNaN(lowestTemp) || isNaN(highestTemp)) {
        console.log('Invalid temperature data');
        return;
    }
    
    const ctx = canvas.getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['æœ€ä½', 'å®æ—¶', 'æœ€é«˜'],
            datasets: [{
                label: 'æ¸©åº¦ (Â°C)',
                data: [lowestTemp, realTemp, highestTemp],
                backgroundColor: [
                    'rgba(54, 162, 235, 0.8)',
                    'rgba(255, 99, 132, 0.8)',
                    'rgba(255, 206, 86, 0.8)'
                ],
                borderColor: [
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 99, 132, 1)',
                    'rgba(255, 206, 86, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'æ¸©åº¦ (Â°C)'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}

// å½“æ¸©åº¦ä¿¡æ¯tabè¢«ç‚¹å‡»æ—¶ç»˜åˆ¶å›¾è¡¨
document.addEventListener('DOMContentLoaded', function() {
    const tempTab = document.querySelector('.info-tab[data-group="temp"]');
    if (tempTab) {
        tempTab.addEventListener('click', function() {
            setTimeout(drawTemperatureChart, 100);
        });
    }
    
    // å¦‚æœé»˜è®¤æ˜¾ç¤ºæ¸©åº¦ä¿¡æ¯ï¼Œç«‹å³ç»˜åˆ¶å›¾è¡¨
    if (document.querySelector('.info-tab[data-group="temp"].active')) {
        setTimeout(drawTemperatureChart, 100);
    }
});
</script>
<script>
// 7å¤©ç•Œé¢äº¤äº’ä¸æŠ˜çº¿å›¾
(function() {
    // åˆ‡æ¢é¡¶éƒ¨æ—¥æœŸtab
    const dayTabs = document.querySelectorAll('.seven-day-tab');
    const dayDetails = document.querySelectorAll('.seven-day-detail-content');
    let currentDayIdx = 0;
    dayTabs.forEach((tab, idx) => {
        tab.addEventListener('click', function() {
            dayTabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            dayDetails.forEach((d, i) => d.style.display = (i === idx ? '' : 'none'));
            currentDayIdx = idx;
        });
    });

    // æ°”è±¡è¦ç´ æŒ‰é’®ä¸æŠ˜çº¿å›¾
    const factorBtns = document.querySelectorAll('.icon-btn');
    let currentFactor = 'real';
    const chartModal = document.getElementById('sevenDaysChartModal');
    let chartInstance = null;
    factorBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            factorBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentFactor = btn.getAttribute('data-factor');
            // å…ˆæ¸…ç©ºcanvas
            const canvas = document.getElementById('sevenDaysChart');
            if (canvas) {
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
            drawSevenDaysChart(currentFactor);
            if(chartModal) chartModal.style.display = 'flex';
        });
    });

    // é»˜è®¤æ¿€æ´»å®æ—¶æ¸©åº¦æŒ‰é’®å¹¶æ˜¾ç¤ºæŠ˜çº¿å›¾å¼¹çª—
    if (factorBtns.length > 0) {
        factorBtns[0].classList.add('active');
        drawSevenDaysChart('real');
        if(chartModal) chartModal.style.display = 'flex';
    }

    // è§£æ7å¤©æ•°æ®
    function getSevenDaysData() {
        const days = [];
        document.querySelectorAll('.seven-day-detail-content').forEach(detail => {
            days.push({
                real: parseFloat(detail.querySelector('.real-temp')?.textContent) || 0,
                lowest: parseFloat(detail.querySelector('.lowest-temp')?.textContent) || 0,
                highest: parseFloat(detail.querySelector('.highest-temp')?.textContent) || 0,
                windspeed: parseFloat(detail.querySelector('.windspeed')?.textContent) || 0,
                humidity: parseFloat(detail.querySelector('.humidity')?.textContent) || 0,
                pcpn: parseFloat(detail.querySelector('.pcpn')?.textContent) || 0,
                uv_index: parseFloat(detail.querySelector('.uv_index')?.textContent) || 0,
                vis: parseFloat(detail.querySelector('.vis')?.textContent) || 0,
            });
        });
        return days;
    }

    // ç»˜åˆ¶æŠ˜çº¿å›¾
    function drawSevenDaysChart(factor) {
        const days = getSevenDaysData();
        const labels = Array.from({length: days.length}, (_, i) => `ç¬¬${i+1}å¤©`);
        const data = days.map(d => d[factor]);
        const canvas = document.getElementById('sevenDaysChart');
        if (!canvas) return;
        if (chartInstance) chartInstance.destroy();
        chartInstance = new Chart(canvas.getContext('2d'), {
            type: 'line',
            data: {
                labels,
                datasets: [{
                    label: factorLabel(factor),
                    data,
                    fill: false,
                    borderColor: 'rgba(54, 162, 235, 0.9)',
                    backgroundColor: 'rgba(54, 162, 235, 0.3)',
                    tension: 0.3,
                    pointRadius: 5,
                    pointHoverRadius: 7
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }
    function factorLabel(factor) {
        switch(factor) {
            case 'real': return 'å®æ—¶æ¸©åº¦(Â°C)';
            case 'lowest': return 'æœ€ä½æ¸©åº¦(Â°C)';
            case 'highest': return 'æœ€é«˜æ¸©åº¦(Â°C)';
            case 'windspeed': return 'é£é€Ÿ';
            case 'humidity': return 'æ¹¿åº¦';
            case 'pcpn': return 'é™æ°´é‡';
            case 'uv_index': return 'ç´«å¤–çº¿æŒ‡æ•°';
            case 'vis': return 'èƒ½è§åº¦';
            default: return '';
        }
    }
    // é»˜è®¤ä¸æ˜¾ç¤ºå›¾è¡¨å¼¹çª—
    // å·²åœ¨ä¸Šæ–¹æ ¹æ®factorBtns[0]æ¿€æ´»æ—¶æ˜¾ç¤º
})();
</script>
<script>
// ç»Ÿä¸€åŠåœ†å½¢è§†é¢‘åˆ‡æ¢é€»è¾‘
document.addEventListener('DOMContentLoaded', function() {
    // ç»Ÿä¸€åŠåœ†å½¢è§†é¢‘åˆ‡æ¢é€»è¾‘
    const weatherVideo = document.getElementById('weatherVideo');
    if (document.getElementById('result1View')) {
        // 1å¤©ç•Œé¢
        if (weatherVideo) {
            const src = '/videos/' + (window.weatherGifPinyin || 'qing') + '.mp4';
            weatherVideo.src = src;
            console.log('[åŠåœ†è§†é¢‘-1å¤©] src:', src);
        }
    } else if (document.getElementById('result7View')) {
        // 7å¤©ç•Œé¢
        const dayTabs = document.querySelectorAll('.seven-day-tab');
        function setVideoByIdx(idx) {
            // è·å–å½“å‰å¤©çš„weatherimgæˆ–pinyin
            const day = window.weatherdata?.result?.list?.[idx];
            let pinyin = day?.weatherGifPinyin || day?.weatherimg || 'qing';
            if (pinyin.endsWith('.png')) pinyin = pinyin.replace('.png', '');
            if (pinyin.endsWith('.mp4')) pinyin = pinyin.replace('.mp4', '');
            const src = '/videos/' + pinyin + '.mp4';
            if (weatherVideo) weatherVideo.src = src;
            console.log(`[åŠåœ†è§†é¢‘-7å¤©] å½“å‰é€‰ä¸­ç¬¬${idx+1}å¤©ï¼Œsrc:`, src, 'day:', day);
        }
        // é»˜è®¤æ˜¾ç¤ºç¬¬0å¤©
        setVideoByIdx(0);
        dayTabs.forEach((tab, idx) => {
            tab.addEventListener('click', function() {
                setVideoByIdx(idx);
            });
        });
    }

    // ç»Ÿä¸€AIåŠ©æ‰‹æ•°æ®æ³¨å…¥é€»è¾‘
    const aiBtn = document.getElementById('ai-assistant-btn');
    const aiModal = document.getElementById('ai-assistant-modal');
    const aiContent = document.getElementById('ai-assistant-content');
    const aiClose = document.getElementById('ai-assistant-close');
    let aiResultCache = null;
    if (aiBtn && aiModal && aiContent && aiClose) {
        aiBtn.onclick = function() {
            aiModal.style.display = 'block';
            if (aiResultCache) {
                aiContent.innerHTML = aiResultCache;
                return;
            }
            let weatherData = '';
            if (document.getElementById('result1View')) {
                // 1å¤©ç•Œé¢ï¼ŒåŸæœ‰é€»è¾‘
                let w = window.weatherdata?.result;
                if (w) {
                    weatherData =
                        'åŸå¸‚: ' + (w.province || '') + ' ' + (w.area || '') + '\n' +
                        'æ—¥æœŸ: ' + (w.date || '') + ' ' + (w.week || '') + '\n' +
                        'å¤©æ°”: ' + (w.weather || '') + '\n' +
                        'å®æ—¶æ¸©åº¦: ' + (w.real || '') + '\n' +
                        'æœ€ä½: ' + (w.lowest || '') + '\n' +
                        'æœ€é«˜: ' + (w.highest || '') + '\n' +
                        'é£å‘: ' + (w.wind || '') + '\n' +
                        'é£é€Ÿ: ' + (w.windspeed || '') + '\n' +
                        'é£åŠ›: ' + (w.windsc || '') + '\n' +
                        'æ¹¿åº¦: ' + (w.humidity || '') + '\n' +
                        'é™æ°´é‡: ' + (w.pcpn || '') + '\n' +
                        'ç´«å¤–çº¿æŒ‡æ•°: ' + (w.uv_index || '') + '\n' +
                        'èƒ½è§åº¦: ' + (w.vis || '') + '\n' +
                        'æ—¥å‡º: ' + (w.sunrise || '') + '\n' +
                        'æ—¥è½: ' + (w.sunset || '') + '\n' +
                        'æœˆå‡: ' + (w.moonrise || '') + '\n' +
                        'æœˆè½: ' + (w.moondown || '');
                }
            } else if (document.getElementById('result7View')) {
                // 7å¤©ç•Œé¢ï¼Œæ³¨å…¥æ‰€æœ‰å¤©æ•°æ®å¹¶æ ‡è®°å½“å‰é€‰ä¸­å¤©
                const dayTabs = document.querySelectorAll('.seven-day-tab');
                let currentIdx = 0;
                dayTabs.forEach((tab, idx) => {
                    if (tab.classList.contains('active')) currentIdx = idx;
                });
                const days = window.weatherdata?.result?.list || [];
                weatherData = 'ã€7å¤©å¤©æ°”æ•°æ®ã€‘\n';
                days.forEach((d, i) => {
                    weatherData += (i === currentIdx ? 'ã€å½“å‰é€‰ä¸­ã€‘' : '') +
                        `ç¬¬${i+1}å¤©: æ—¥æœŸ:${d.date} ${d.week} å¤©æ°”:${d.weather} å®æ—¶æ¸©åº¦:${d.real} æœ€ä½:${d.lowest} æœ€é«˜:${d.highest} é£é€Ÿ:${d.windspeed} æ¹¿åº¦:${d.humidity} é™æ°´é‡:${d.pcpn} ç´«å¤–çº¿:${d.uv_index} èƒ½è§åº¦:${d.vis}` + '\n';
                });
                console.log('[AIåŠ©æ‰‹-7å¤©] å½“å‰é€‰ä¸­ç¬¬', currentIdx+1, 'å¤©ï¼ŒweatherData:', weatherData, 'days:', days);
            }
            console.log('[AIåŠ©æ‰‹] weatherData:', weatherData);
            aiContent.innerText = 'AIåˆ†æä¸­...';
            fetch('/api/ai-analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ weatherInfo: weatherData })
            })
            .then(res => res.json())
            .then(data => {
                if (data.result) {
                    aiResultCache = window.marked ? marked.parse(data.result) : data.result;
                    aiContent.innerHTML = aiResultCache;
                } else if (data.error) {
                    aiResultCache = 'AIåˆ†æå¤±è´¥ï¼š' + (data.detail || data.error);
                    aiContent.innerText = aiResultCache;
                } else {
                    aiResultCache = 'AIæœªèƒ½è¿”å›åˆ†æç»“æœã€‚';
                    aiContent.innerText = aiResultCache;
                }
            })
            .catch(e => {
                aiResultCache = 'AIåˆ†æå¤±è´¥ï¼š' + e;
                aiContent.innerText = aiResultCache;
            });
        };
        aiClose.onclick = function() { aiModal.style.display = 'none'; };
    }
});
</script>
<script>
// ä¸€å¤©ç•Œé¢åŠåœ†ç‚¹å‡»è¿”å›æŸ¥è¯¢ç•Œé¢
var resultSemicircle = document.querySelector('.result-semicircle');
if (resultSemicircle) {
    resultSemicircle.addEventListener('click', function() {
        // systemæ—¥å¿—
        console.log('[system] å›åˆ°æŸ¥è¯¢ç•Œé¢å¹¶è·³è½¬');
        // è·³è½¬å›æŸ¥è¯¢ç•Œé¢ï¼Œæ¸…é™¤æŸ¥è¯¢å‚æ•°
        window.location.replace('http://localhost:7070/getWeatherThy');
    });
}
</script>
</body>
</html> 